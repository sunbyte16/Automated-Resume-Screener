{% extends "base.html" %}

{% block title %}Profile - {{ user.username }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <!-- Profile Header -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user me-2"></i>
                        User Profile
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">{{ user.username }}</h5>
                            <p class="card-text mb-1">
                                <i class="fas fa-envelope me-2 text-muted"></i>
                                {{ user.email }}
                            </p>
                            <p class="card-text mb-1">
                                <i class="fas fa-shield-alt me-2 text-muted"></i>
                                {% if user.is_admin %}
                                    <span class="badge bg-danger">Administrator</span>
                                {% else %}
                                    <span class="badge bg-primary">User</span>
                                {% endif %}
                            </p>
                            <p class="card-text text-muted small mt-2">
                                <i class="far fa-calendar me-1"></i>
                                Member since {{ user.id }} <!-- You might want to add a created_at field -->
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="mb-3">
                                <i class="fas fa-user-circle fa-5x text-muted"></i>
                            </div>
                            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                <i class="fas fa-edit me-1"></i> Edit Profile
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Resumes -->
            <div class="card mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        My Resumes
                    </h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-plus me-1"></i> Upload New
                    </button>
                </div>
                <div class="card-body">
                    <div id="resumesList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading your resumes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Statistics -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary mb-0" id="totalResumes">-</h4>
                            <small class="text-muted">Total Resumes</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-0" id="avgScore">-</h4>
                            <small class="text-muted">Avg Score</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-info mb-0" id="processedResumes">-</h4>
                            <small class="text-muted">Processed</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning mb-0" id="pendingResumes">-</h4>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('main.list_jobs') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-briefcase me-2 text-primary"></i> Browse Jobs
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-upload me-2 text-success"></i> Upload Resume
                    </a>
                    {% if user.is_admin %}
                    <a href="{{ url_for('admin.dashboard') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-tachometer-alt me-2 text-warning"></i> Admin Dashboard
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Account Settings -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Account Settings
                    </h5>
                </div>
                <div class="list-group list-group-flush">
                    <button class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                        <i class="fas fa-key me-2 text-info"></i> Change Password
                    </button>
                    <a href="{{ url_for('auth.logout') }}" class="list-group-item list-group-item-action text-danger">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Resume Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Upload Resume</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.upload_file') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="resume" class="form-label">Select Resume (PDF or DOCX)</label>
                        <input class="form-control" type="file" id="resume" name="resume" accept=".pdf,.docx" required>
                        <div class="form-text">Maximum file size: 16MB</div>
                    </div>
                    <div class="mb-3">
                        <label for="job_id" class="form-label">Job Position (Optional)</label>
                        <select class="form-select" id="job_id" name="job_id">
                            <option value="">Select a job position (optional)</option>
                            <!-- Jobs will be loaded via JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload & Analyze</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editProfileForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" name="new_password" required>
                        <div class="form-text">Password must be at least 8 characters long.</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Load user's resumes
    loadResumes();
    loadJobs();
    
    // Handle edit profile form
    $('#editProfileForm').on('submit', function(e) {
        e.preventDefault();
        // In a real app, this would make an AJAX call to update the profile
        alert('Profile update functionality would be implemented here.');
    });
    
    // Handle change password form
    $('#changePasswordForm').on('submit', function(e) {
        e.preventDefault();
        // In a real app, this would make an AJAX call to change the password
        alert('Password change functionality would be implemented here.');
    });
});

function loadResumes() {
    $.get('/api/resumes')
        .done(function(data) {
            displayResumes(data);
            updateStatistics(data);
        })
        .fail(function() {
            $('#resumesList').html('<div class="text-center py-4"><p class="text-muted">Error loading resumes.</p></div>');
        });
}

function displayResumes(resumes) {
    if (resumes.length === 0) {
        $('#resumesList').html(`
            <div class="text-center py-4">
                <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                <h5>No Resumes Yet</h5>
                <p class="text-muted">Upload your first resume to get started!</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-upload me-2"></i>Upload Resume
                </button>
            </div>
        `);
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Filename</th><th>Score</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
    
    resumes.forEach(function(resume) {
        const scoreBadge = resume.score ? 
            `<span class="badge bg-${resume.score >= 70 ? 'success' : resume.score >= 50 ? 'warning' : 'danger'}">${resume.score}%</span>` :
            '<span class="badge bg-secondary">Not Scored</span>';
            
        const statusBadge = `<span class="badge bg-${resume.status === 'processed' ? 'success' : resume.status === 'processing' ? 'warning' : 'secondary'}">${resume.status}</span>`;
        
        html += `
            <tr>
                <td>${resume.filename}</td>
                <td>${scoreBadge}</td>
                <td>${statusBadge}</td>
                <td>${new Date(resume.upload_date).toLocaleDateString()}</td>
                <td>
                    <a href="/resume/${resume.id}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> View
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    $('#resumesList').html(html);
}

function updateStatistics(resumes) {
    const total = resumes.length;
    const processed = resumes.filter(r => r.status === 'processed').length;
    const pending = resumes.filter(r => r.status === 'pending' || r.status === 'processing').length;
    const avgScore = processed > 0 ? 
        Math.round(resumes.filter(r => r.score).reduce((sum, r) => sum + r.score, 0) / resumes.filter(r => r.score).length) : 0;
    
    $('#totalResumes').text(total);
    $('#processedResumes').text(processed);
    $('#pendingResumes').text(pending);
    $('#avgScore').text(avgScore + '%');
}

function loadJobs() {
    // In a real app, this would load jobs from the API
    // For now, we'll just add a placeholder
    $('#job_id').append('<option value="1">Sample Job 1</option>');
    $('#job_id').append('<option value="2">Sample Job 2</option>');
}
</script>
{% endblock %}
